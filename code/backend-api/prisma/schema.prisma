// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ========================================
// 管理员表
// ========================================
model Admin {
  id        String   @id @default(uuid())
  username  String   @unique
  password  String
  email     String?  @unique
  role      String   @default("admin") // admin, super_admin
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("admins")
}

// ========================================
// 业务员表
// ========================================
model Salesperson {
  id           String   @id @default(uuid())
  accountId    String   @unique @map("account_id")
  chineseName  String   @map("chinese_name")
  englishName  String   @map("english_name")
  email        String?  @unique
  phone        String?
  hireDate     DateTime @map("hire_date")
  avatar       String?
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  customers    Customer[]
  orders       Order[]

  @@map("salespersons")
}

// ========================================
// 客户表（外网版本 - 支持注册登录）
// ========================================
model Customer {
  id              String   @id @default(uuid())
  email           String   @unique // 外网版：邮箱唯一，用于登录
  password        String?  // 外网版：密码哈希（bcrypt）
  name            String   // 公司名称或客户名称
  contactPerson   String?  @map("contact_person")
  phone           String?
  address         String?
  country         String?  // 国家/地区

  // 内网版字段（外网不使用，但保留兼容性）
  salespersonId   String?  @map("salesperson_id")
  customerType    CustomerType @default(NEW) @map("customer_type")

  // 客户等级（产品权限控制）
  tier            CustomerTier @default(STANDARD) @map("customer_tier")

  status          String   @default("active") // active/disabled
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  salesperson     Salesperson? @relation(fields: [salespersonId], references: [id])
  orders          Order[]
  orderForms      OrderForm[] // 外网版：订单表单关系
  cartItems       CartItem[] // 外网版：购物车关系

  @@map("customers")
}

enum CustomerType {
  NEW @map("new")
  OLD @map("old")
}

enum CustomerTier {
  STANDARD @map("standard") // 普通客户
  VIP      @map("vip")      // VIP客户
  SVIP     @map("svip")     // SVIP客户
}

// ========================================
// 订单表
// ========================================
model Order {
  id              String   @id @default(uuid())
  orderNumber     String   @unique @map("order_number")
  customerId      String   @map("customer_id")
  salespersonId   String   @map("salesperson_id")
  customerType    CustomerType @map("customer_type")
  orderType       OrderType @map("order_type")
  orderDate       DateTime @map("order_date")
  status          String   @default("pending")
  companyName     String?  @map("company_name") // 公司名称 (如: 东阳市铭品日用品有限公司)
  totalAmount     Decimal? @map("total_amount")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  customer        Customer @relation(fields: [customerId], references: [id])
  salesperson     Salesperson @relation(fields: [salespersonId], references: [id])
  customParams    OrderCustomParam[]
  items           OrderItem[]

  @@map("orders")
}

enum OrderType {
  FORMAL    @map("formal")
  INTENTION @map("intention")
}

// ========================================
// 订单自定义参数表
// ========================================
model OrderCustomParam {
  id          String   @id @default(uuid())
  orderId     String   @map("order_id")
  paramKey    String   @map("param_key")
  paramValue  String?  @map("param_value")
  createdAt   DateTime @default(now()) @map("created_at")

  order       Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("order_custom_params")
}

// ========================================
// 订单明细表
// ========================================
model OrderItem {
  id                    String   @id @default(uuid())
  orderId               String   @map("order_id")
  productSkuId          String   @map("product_sku_id")
  itemNumber            Int      @default(1) @map("item_number") // 项次序号
  customerProductCode   String?  @map("customer_product_code") // 客户料号
  productImage          String?  @map("product_image") // 货品图片
  productSpec           String?  @map("product_spec") // 货品规格
  additionalAttributes  String?  @map("additional_attributes") // 附加属性
  quantity              Int
  packagingConversion   Decimal? @map("packaging_conversion") // 包装换算
  packagingUnit         String?  @map("packaging_unit") // 包装单位 (如: 125箱)
  weightUnit            String?  @map("weight_unit") // 重量单位
  netWeight             Decimal? @map("net_weight") // 包装净重
  grossWeight           Decimal? @map("gross_weight") // 包装毛重
  packagingType         String?  @map("packaging_type") // 包装类型
  packagingSize         String?  @map("packaging_size") // 包装大小
  supplierNote          String?  @map("supplier_note") // 厂商备注
  expectedDeliveryDate  DateTime? @map("expected_delivery_date") // 预交日
  price                 Decimal
  untaxedLocalCurrency  Decimal? @map("untaxed_local_currency") // 未税本位币
  packingQuantity       Int?     @map("packing_quantity") // 装箱数
  cartonQuantity        Int?     @map("carton_quantity") // 箱数
  packagingMethod       String?  @map("packaging_method") // 包装方式
  paperCardCode         String?  @map("paper_card_code") // 纸卡编码
  washLabelCode         String?  @map("wash_label_code") // 水洗标编码
  outerCartonCode       String?  @map("outer_carton_code") // 外箱编码
  cartonSpecification   String?  @map("carton_specification") // 箱规
  volume                Decimal? // 体积
  summary               String?  // 摘要
  subtotal              Decimal
  createdAt             DateTime @default(now()) @map("created_at")

  order           Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productSku      ProductSku @relation(fields: [productSkuId], references: [id])

  @@map("order_items")
}

// ========================================
// 订单参数配置表
// ========================================
model OrderParamConfig {
  id            String   @id @default(uuid())
  fieldName     String   @unique @map("field_name")
  fieldNameZh   String   @map("field_name_zh")
  fieldType     ParamFieldType @map("field_type")
  isRequired    Boolean  @default(false) @map("is_required")
  defaultValue  String?  @map("default_value")
  options       Json?    // For select type
  displayOrder  Int      @default(0) @map("display_order")
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")

  @@map("order_param_configs")
}

enum ParamFieldType {
  TEXT     @map("text")
  NUMBER   @map("number")
  DATE     @map("date")
  SELECT   @map("select")
  TEXTAREA @map("textarea")
}

// ========================================
// 分类表 (2025-10-31 更新: 增加分类代码和自动创建标识)
// ========================================
model Category {
  id              String   @id @default(uuid())
  code            String   @unique // 分类代码 (如: MP, TB, T, B, S, CG, CD, MB, QC, CW, W)
  nameZh          String   @map("name_zh") // 中文名称 (如: 组合套装, 拖把类)
  nameEn          String   @map("name_en") // 英文名称 (如: Combo Sets, Mops)
  icon            String? // 图标URL
  sortOrder       Int      @default(0) @map("sort_order")
  isAutoCreated   Boolean  @default(false) @map("is_auto_created") // 是否自动创建
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  productGroups ProductGroup[]

  @@map("categories")
}

// ========================================
// 材料表 (已废弃 - 新需求不使用材料筛选)
// ========================================
// model Material {
//   id        String   @id @default(uuid())
//   nameZh    String   @map("name_zh")
//   nameEn    String   @map("name_en")
//   isActive  Boolean  @default(true) @map("is_active")
//   createdAt DateTime @default(now()) @map("created_at")
//
//   @@map("materials")
// }

// ========================================
// 商品组表 (2025-10-31 更新: 品号前缀分组 + 视频复用 + 计算字段)
// ========================================
model ProductGroup {
  id              String   @id @default(uuid())
  prefix          String   @unique // 品号前缀 (如: MP007, TB001) - 唯一标识
  groupNameZh     String   @map("group_name_zh") // SKU组名称-中文 (如: MP007系列)
  groupNameEn     String   @map("group_name_en") // SKU组名称-英文 (如: MP007 Series)
  categoryId      String?  @map("category_id") // 关联分类
  categoryCode    String?  @map("category_code") // 冗余存储分类代码 (如: MP, TB)
  descriptionZh   String?  @map("description_zh") // 产品描述-中文
  descriptionEn   String?  @map("description_en") // 产品描述-英文

  // 视频复用功能
  sharedVideo     Json?    @map("shared_video") // SKU组共用视频 (JSON: {url, size, duration, thumbnail})
  videoMode       String   @default("shared") @map("video_mode") // 视频模式: shared/individual

  // 计算字段 (从SKU规格中自动计算)
  minPrice        Decimal? @map("min_price") // 最低价
  maxPrice        Decimal? @map("max_price") // 最高价
  specCount       Int      @default(0) @map("spec_count") // 规格数量
  mainImage       String?  @map("main_image") // 主图 (第一个规格的第一张图片)

  isPublished     Boolean  @default(false) @map("is_published") // 是否上架
  sortOrder       Int      @default(0) @map("sort_order") // 排序权重
  status          String   @default("inactive") // active/inactive

  // 产品可见性控制 (2025-11-09 新增)
  visibilityTier  ProductVisibility @default(ALL) @map("visibility_tier") // 可见性等级

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  category        Category? @relation(fields: [categoryId], references: [id])
  skus            ProductSku[]
  featuredSpots   HomepageFeatured[]

  @@map("product_groups")
}

// ========================================
// 品号SKU表 (2025-10-31 更新: 货品规格 + 图片集 + 视频)
// ========================================
model ProductSku {
  id                    String   @id @default(uuid())
  groupId               String   @map("group_id") // 所属SKU组
  productCode           String   @unique @map("product_code") // 品号/SKU编码 (如: C10.01.0013)
  productName           String   @map("product_name") // 品名 (如: MP007-清洁四件套)

  // 主标题和副标题 (后台可编辑)
  title                 String?  // 主标题 (显示在规格选择器第一行，默认为productName)
  subtitle              String?  // 副标题 (显示在主标题下方，可选)

  brand                 String? // 商标

  // 规格信息 (从Excel导入) - 2025-11-01 更新: 支持部件化规格
  specification         String?  // 货品规格原始文本 (Excel原始内容)
  productSpec           Json?    @map("product_spec") // 解析后的部件规格 (JSON数组)
  /*
  productSpec 格式:
  [
    {
      "code": "A",
      "name": "伸缩铁杆",
      "spec": "φ19/22*0.27mm*1200mm",
      "description": "意标螺纹"
    }
  ]
  */

  additionalAttributes  Json?    @map("additional_attributes") // 解析后的颜色属性 (JSON数组) - 已废弃，保留兼容
  /*
  additionalAttributes 格式 (已废弃):
  [
    {
      "componentCode": "A",
      "colors": [
        { "part": "喷塑", "color": "3C冷灰" },
        { "part": "塑件", "color": "10C冷灰" }
      ]
    }
  ]
  */

  optionalAttributes    Json?    @map("optional_attributes") // 可选属性配置 (JSON数组)
  /*
  optionalAttributes 格式:
  [
    {
      "nameZh": "材质",
      "nameEn": "Material",
      "options": [
        { "labelZh": "棉质", "labelEn": "Cotton", "value": "cotton" },
        { "labelZh": "化纤", "labelEn": "Polyester", "value": "polyester" }
      ]
    }
  ]
  */

  // 价格和图片视频 (后台配置)
  price                 Decimal? // 销售单价 (后台填写)
  images                Json?    // 图片集 (JSON数组: [{url, order, size, width, height}])
  video                 Json?    // 独立视频 (JSON: {url, size, duration, thumbnail})
  useSharedVideo        Boolean  @default(true) @map("use_shared_video") // 是否使用SKU组共用视频

  importDate            DateTime? @map("import_date") // 导入时间
  status                SkuStatus @default(INACTIVE) // active/inactive (默认未上架)
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  group             ProductGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  orderItems        OrderItem[]

  @@map("product_skus")
}

enum SkuStatus {
  ACTIVE   @map("active")
  INACTIVE @map("inactive")
}

// ========================================
// 首页精选系列展示位表 (2025-10-31 新增)
// ========================================
model HomepageFeatured {
  id              String   @id @default(uuid())
  groupId         String   @map("group_id") // 关联的SKU组ID
  featuredImage   String   @map("featured_image") // 展示图片URL
  titleZh         String   @map("title_zh") // 标题-中文
  titleEn         String   @map("title_en") // 标题-英文
  descriptionZh   String?  @map("description_zh") // 描述-中文
  descriptionEn   String?  @map("description_en") // 描述-英文
  sortOrder       Int      @map("sort_order") // 排序 (1-4)
  status          String   @default("active") // active/inactive
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  group           ProductGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@map("homepage_featured")
}

// ========================================
// 系统配置表
// ========================================
model SystemConfig {
  id          String   @id @default(uuid())
  configKey   String   @unique @map("config_key")
  configValue String?  @map("config_value")
  configType  String?  @map("config_type") // json, text, number
  description String?
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("system_configs")
}

// ========================================
// 订阅表
// ========================================
model Subscription {
  id            String   @id @default(uuid())
  email         String   @unique
  source        String?  // footer, popup, etc
  status        SubscriptionStatus @default(ACTIVE)
  subscribedAt  DateTime @default(now()) @map("subscribed_at")

  @@map("subscriptions")
}

enum SubscriptionStatus {
  ACTIVE       @map("active")
  UNSUBSCRIBED @map("unsubscribed")
}

// ========================================
// 合作申请表
// ========================================
model PartnershipApplication {
  id        String   @id @default(uuid())
  name      String
  company   String?
  email     String
  phone     String?
  message   String? 
  status    PartnershipStatus @default(PENDING)
  notes     String? 
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("partnership_applications")
}

enum PartnershipStatus {
  PENDING   @map("pending")
  CONTACTED @map("contacted")
  PARTNERED @map("partnered")
  REJECTED  @map("rejected")
}

// ========================================
// 资质认证表
// ========================================
model Certification {
  id                 String   @id @default(uuid())
  nameZh             String   @map("name_zh")
  nameEn             String   @map("name_en")
  category           CertCategory
  certificateType    String?  @map("certificate_type") // ISO9001, CE, FDA等
  fileUrl            String   @map("file_url")
  fileType           String?  @map("file_type") // pdf, jpg, png
  thumbnailUrl       String?  @map("thumbnail_url")
  issueDate          DateTime? @map("issue_date")
  expiryDate         DateTime? @map("expiry_date")
  issuingAuthority   String?  @map("issuing_authority")
  certificateNumber  String?  @map("certificate_number")
  descriptionZh      String?  @map("description_zh")
  descriptionEn      String?  @map("description_en")
  displayOrder       Int      @default(0) @map("display_order")
  isActive           Boolean  @default(true) @map("is_active")
  showOnFrontend     Boolean  @default(false) @map("show_on_frontend")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  @@map("certifications")
}

enum CertCategory {
  FACTORY @map("factory")
  PRODUCT @map("product")
  PATENT  @map("patent")
  HONOR   @map("honor")
  OTHER   @map("other")
}

// ========================================
// 订单表单表（外网版本 - 仅收集订单咨询信息）
// ========================================
model OrderForm {
  id              String   @id @default(uuid())
  formNumber      String   @unique @map("form_number") // 表单编号，如: OF2025-001
  customerId      String   @map("customer_id")

  // 联系信息
  contactName     String   @map("contact_name")
  phone           String
  email           String
  address         String
  notes           String?  // 备注

  // 商品信息（JSON格式存储）
  items           Json     // 购物车内容：产品+配置+数量
  /*
  items 格式:
  [
    {
      "product_id": "123",
      "product_code": "MP007-BLU-WHT",
      "product_name": "Rotating Mop Set",
      "quantity": 2,
      "unit_price": 299.00,
      "configuration": {
        "base": { "color": "Blue" },
        "handle": { "color": "White" }
      }
    }
  ]
  */

  totalAmount     String   @map("total_amount") // 总金额（仅参考）

  // 状态（固定为submitted）
  status          String   @default("submitted")

  // 时间戳
  submittedAt     DateTime @map("submitted_at")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  customer        Customer @relation(fields: [customerId], references: [id])

  @@map("order_forms")
}

// ========================================
// 组件管理表 (2025-11-10 新增)
// ========================================
model Component {
  id          String   @id @default(uuid())
  code        String   @unique // 组件代码，如: A, B, C
  nameZh      String   @map("name_zh") // 组件中文名称，如: 拖把杆
  nameEn      String   @map("name_en") // 组件英文名称，如: Mop Handle
  description String?  // 组件描述（可选）
  parts       Json?    // 部件列表，格式: [{ nameZh: "杆身", nameEn: "Pole Body" }, ...]
  sortOrder   Int      @default(0) @map("sort_order") // 排序权重
  isActive    Boolean  @default(true) @map("is_active") // 是否启用
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("components")
}

// ========================================
// 枚举：产品可见性等级 (2025-11-09 新增)
// ========================================
enum ProductVisibility {
  ALL      @map("all")      // 所有人可见（未登录、普通、VIP、SVIP）
  STANDARD @map("standard") // 普通及以上可见（普通、VIP、SVIP）
  VIP      @map("vip")      // VIP及以上可见（VIP、SVIP）
  SVIP     @map("svip")     // 仅SVIP可见
}

// ========================================
// 购物车表 (2025-11-10 新增)
// ========================================
model CartItem {
  id              String   @id @default(uuid())
  customerId      String   @map("customer_id")
  skuId           String   @map("sku_id")
  productCode     String   @map("product_code") // 产品代码，如: C04.01.0021
  productName     String   @map("product_name") // 产品名称
  colorScheme     Json?    @map("color_scheme") // 配色方案 JSON
  quantity        Int      @default(1)
  price           Decimal  @db.Decimal(10, 2) // 单价
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  customer        Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@unique([customerId, skuId, colorScheme])
  @@index([customerId])
  @@map("cart_items")
}
