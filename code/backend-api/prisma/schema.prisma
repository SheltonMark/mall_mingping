// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ========================================
// 管理员表
// ========================================
model Admin {
  id        String   @id @default(uuid())
  username  String   @unique
  password  String
  email     String?  @unique
  role      String   @default("admin") // admin, super_admin
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("admins")
}

// ========================================
// 业务员表（内网版本 - ERP同步）
// ========================================
model Salesperson {
  id           String   @id @default(uuid())
  accountId    String   @unique @map("account_id") // 工号（ERP SAL_NO，如 MP0001）
  chineseName  String   @map("chinese_name")       // 中文名（ERP NAME）
  englishName  String?  @map("english_name")       // 英文名（ERP ENG_NAME）
  department   String?                             // 部门（ERP DEP）
  position     String?                             // 职位（ERP POS）
  password     String                              // 密码哈希（本地维护）
  erpSyncAt    DateTime? @map("erp_sync_at")       // ERP同步时间
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  customers    Customer[] // 业务员的客户（网站客户）
  erpCustomers ErpCustomer[] // 业务员的ERP客户
  orders       Order[]
  cartItems    CartItem[] // 业务员的购物车

  @@map("salespersons")
}

// ========================================
// 客户表（内网版本 - 业务员创建并维护的网站客户）
// ========================================
model Customer {
  id              String   @id @default(uuid())
  email           String   @unique // 邮箱（联系方式）
  name            String   // 公司名称或客户名称
  contactPerson   String?  @map("contact_person")
  phone           String?
  address         String?
  country         String?  // 国家/地区

  salespersonId   String   @map("salesperson_id") // 关联的业务员（创建者）

  customerType    CustomerType @default(NEW) @map("customer_type")
  remarks         String?  // 备注
  status          String   @default("active") // active/disabled
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  salesperson     Salesperson @relation(fields: [salespersonId], references: [id])
  orders          Order[]

  @@map("customers")
}

// ========================================
// ERP客户表（从ERP同步，只读）
// ========================================
model ErpCustomer {
  id              String   @id @default(uuid())
  cusNo           String   @unique @map("cus_no")     // ERP客户编号（CUS_NO，如 C0098, D04057）
  name            String                              // 客户全称（ERP NAME）
  shortName       String?  @map("short_name")         // 客户简称（ERP SNM）
  country         String?                             // 国家（ERP COUNTRY）
  phone           String?                             // 电话（ERP TEL1）
  email           String?                             // 邮箱（ERP E_MAIL）
  address         String?                             // 地址（ERP ADR1）
  contactPerson   String?  @map("contact_person")     // 联系人（ERP CNT_MAN1）
  salespersonNo   String?  @map("salesperson_no")     // 所属业务员编号（ERP SAL）
  salespersonId   String?  @map("salesperson_id")     // 关联的业务员ID
  erpSyncAt       DateTime @default(now()) @map("erp_sync_at") // ERP同步时间
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  salesperson     Salesperson? @relation(fields: [salespersonId], references: [id])
  orders          Order[]

  @@map("erp_customers")
}

enum CustomerType {
  NEW @map("new")
  OLD @map("old")
}

// ========================================
// 订单表
// ========================================
model Order {
  id              String   @id @default(uuid())
  orderNumber     String   @unique @map("order_number")
  customerId      String?  @map("customer_id")          // 网站客户ID（可选，兼容旧数据）
  erpCustomerId   String?  @map("erp_customer_id")      // ERP客户ID（新订单使用）
  salespersonId   String   @map("salesperson_id")
  customerType    CustomerType @map("customer_type")
  orderType       OrderType @map("order_type")
  orderDate       DateTime @map("order_date")
  status          OrderStatus @default(PENDING) // 订单状态
  companyName     String?  @map("company_name") // 公司名称 (如: 东阳市铭品日用品有限公司)
  totalAmount     Decimal? @map("total_amount")
  rejectReason    String?  @map("reject_reason") // 驳回原因

  // ERP 同步相关字段
  erpOrderNo      String?  @map("erp_order_no") // ERP订单号（如 SO202511044）
  erpSyncAt       DateTime? @map("erp_sync_at")
  erpSyncError    String?  @map("erp_sync_error")

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  customer        Customer? @relation(fields: [customerId], references: [id])
  erpCustomer     ErpCustomer? @relation(fields: [erpCustomerId], references: [id])
  salesperson     Salesperson @relation(fields: [salespersonId], references: [id])
  customParams    OrderCustomParam[]
  items           OrderItem[]

  @@map("orders")
}

// 订单状态枚举
enum OrderStatus {
  PENDING      @map("pending")      // 待审核
  APPROVED     @map("approved")     // 已审核（待同步）
  REJECTED     @map("rejected")     // 已驳回
  SYNCED       @map("synced")       // 已同步ERP
  SYNC_FAILED  @map("sync_failed")  // 同步失败
}

enum OrderType {
  FORMAL    @map("formal")
  INTENTION @map("intention")
}

// ========================================
// 订单自定义参数表
// ========================================
model OrderCustomParam {
  id          String   @id @default(uuid())
  orderId     String   @map("order_id")
  paramKey    String   @map("param_key")
  paramValue  String?  @map("param_value")
  createdAt   DateTime @default(now()) @map("created_at")

  order       Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("order_custom_params")
}

// ========================================
// 订单明细表
// ========================================
model OrderItem {
  id                    String   @id @default(uuid())
  orderId               String   @map("order_id")
  productSkuId          String   @map("product_sku_id")
  itemNumber            Int      @default(1) @map("item_number") // 项次序号
  customerProductCode   String?  @map("customer_product_code") // 客户料号
  productImage          String?  @map("product_image") // 货品图片
  productSpec           String?  @map("product_spec") // 货品规格
  additionalAttributes  String?  @map("additional_attributes") // 附加属性
  quantity              Int
  packagingConversion   Decimal? @map("packaging_conversion") // 包装换算
  packagingUnit         String?  @map("packaging_unit") // 包装单位 (如: 125箱)
  weightUnit            String?  @map("weight_unit") // 重量单位
  netWeight             Decimal? @map("net_weight") // 包装净重
  grossWeight           Decimal? @map("gross_weight") // 包装毛重
  packagingType         String?  @map("packaging_type") // 包装类型
  packagingSize         String?  @map("packaging_size") // 包装大小
  supplierNote          String?  @map("supplier_note") // 厂商备注
  expectedDeliveryDate  DateTime? @map("expected_delivery_date") // 预交日
  price                 Decimal
  untaxedLocalCurrency  Decimal? @map("untaxed_local_currency") // 未税本位币
  packingQuantity       Int?     @map("packing_quantity") // 装箱数
  cartonQuantity        Int?     @map("carton_quantity") // 箱数
  packagingMethod       String?  @map("packaging_method") // 包装方式
  paperCardCode         String?  @map("paper_card_code") // 纸卡编码
  washLabelCode         String?  @map("wash_label_code") // 水洗标编码
  outerCartonCode       String?  @map("outer_carton_code") // 外箱编码
  cartonSpecification   String?  @map("carton_specification") // 箱规
  volume                Decimal? // 体积
  summary               String?  // 摘要
  subtotal              Decimal
  createdAt             DateTime @default(now()) @map("created_at")

  order           Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productSku      ProductSku @relation(fields: [productSkuId], references: [id])

  @@map("order_items")
}

// ========================================
// 订单参数配置表
// ========================================
model OrderParamConfig {
  id            String   @id @default(uuid())
  fieldName     String   @unique @map("field_name")
  fieldNameZh   String   @map("field_name_zh")
  fieldType     ParamFieldType @map("field_type")
  isRequired    Boolean  @default(false) @map("is_required")
  defaultValue  String?  @map("default_value")
  options       Json?    // For select type
  displayOrder  Int      @default(0) @map("display_order")
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")

  @@map("order_param_configs")
}

enum ParamFieldType {
  TEXT     @map("text")
  NUMBER   @map("number")
  DATE     @map("date")
  SELECT   @map("select")
  TEXTAREA @map("textarea")
}

// ========================================
// 分类表 (2025-10-31 更新: 增加分类代码和自动创建标识)
// ========================================
model Category {
  id              String   @id @default(uuid())
  code            String   @unique // 分类代码 (如: MP, TB, T, B, S, CG, CD, MB, QC, CW, W)
  nameZh          String   @map("name_zh") // 中文名称 (如: 组合套装, 拖把类)
  nameEn          String?  @map("name_en") // 英文名称 (如: Combo Sets, Mops)
  icon            String? // 图标URL
  sortOrder       Int      @default(0) @map("sort_order")
  isAutoCreated   Boolean  @default(false) @map("is_auto_created") // 是否自动创建
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  productGroups ProductGroup[]

  @@map("categories")
}

// ========================================
// 材料表 (已废弃 - 新需求不使用材料筛选)
// ========================================
// model Material {
//   id        String   @id @default(uuid())
//   nameZh    String   @map("name_zh")
//   nameEn    String   @map("name_en")
//   isActive  Boolean  @default(true) @map("is_active")
//   createdAt DateTime @default(now()) @map("created_at")
//
//   @@map("materials")
// }

// ========================================
// 商品组表 (2025-10-31 更新: 品号前缀分组 + 视频复用 + 计算字段)
// ========================================
model ProductGroup {
  id              String   @id @default(uuid())
  prefix          String   @unique // 品号前缀 (如: MP007, TB001) - 唯一标识
  groupNameZh     String   @map("group_name_zh") // SKU组名称-中文 (如: MP007系列)
  groupNameEn     String   @map("group_name_en") // SKU组名称-英文 (如: MP007 Series)
  categoryId      String?  @map("category_id") // 关联分类
  categoryCode    String?  @map("category_code") // 冗余存储分类代码 (如: MP, TB)
  descriptionZh   String?  @map("description_zh") // 产品描述-中文
  descriptionEn   String?  @map("description_en") // 产品描述-英文

  // 视频复用功能
  sharedVideo     Json?    @map("shared_video") // SKU组共用视频 (JSON: {url, size, duration, thumbnail})
  videoMode       String   @default("shared") @map("video_mode") // 视频模式: shared/individual

  // 附加属性 (2025-11-15 新增)
  optionalAttributes Json?  @map("optional_attributes") // 附加属性 (JSON数组: [{nameZh, nameEn}])

  // 计算字段 (从SKU规格中自动计算)
  minPrice        Decimal? @map("min_price") // 最低价
  maxPrice        Decimal? @map("max_price") // 最高价
  specCount       Int      @default(0) @map("spec_count") // 规格数量
  mainImage       String?  @map("main_image") // 主图 (第一个规格的第一张图片)

  isPublished     Boolean  @default(false) @map("is_published") // 是否上架
  sortOrder       Int      @default(0) @map("sort_order") // 排序权重
  status          String   @default("inactive") // active/inactive

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  category        Category? @relation(fields: [categoryId], references: [id])
  skus            ProductSku[]
  featuredSpots   HomepageFeatured[]

  @@map("product_groups")
}

// ========================================
// 品号SKU表 (2025-10-31 更新: 货品规格 + 图片集 + 视频)
// ========================================
model ProductSku {
  id                    String   @id @default(uuid())
  groupId               String   @map("group_id") // 所属SKU组
  productCode           String   @unique @map("product_code") // 品号/SKU编码 (如: C10.01.0013)
  productName           String   @map("product_name") // 品名 (如: MP007-清洁四件套)
  productNameEn         String?  @map("product_name_en") // 品名英文

  // 主标题和副标题 (后台可编辑)
  title                 String?  // 主标题 (显示在规格选择器第一行，默认为productName)
  subtitle              String?  // 副标题 (显示在主标题下方，可选)

  brand                 String? // 商标

  // 规格信息 (从Excel导入) - 2025-11-01 更新: 支持部件化规格
  specification         String?  // 货品规格原始文本 (Excel原始内容)
  productSpec           Json?    @map("product_spec") // 解析后的部件规格 (JSON数组)
  specificationEn       String?  @map("specification_en") // 货品规格英文
  /*
  productSpec 格式:
  [
    {
      "code": "A",
      "name": "伸缩铁杆",
      "spec": "φ19/22*0.27mm*1200mm",
      "description": "意标螺纹"
    }
  ]
  */

  additionalAttributes  Json?    @map("additional_attributes") // 解析后的颜色属性 (JSON数组) - 已废弃，保留兼容
  /*
  additionalAttributes 格式 (已废弃):
  [
    {
      "componentCode": "A",
      "colors": [
        { "part": "喷塑", "color": "3C冷灰" },
        { "part": "塑件", "color": "10C冷灰" }
      ]
    }
  ]
  */

  optionalAttributes    Json?    @map("optional_attributes") // 可选属性配置 (JSON数组)
  /*
  optionalAttributes 格式:
  [
    {
      "nameZh": "材质",
      "nameEn": "Material",
      "options": [
        { "labelZh": "棉质", "labelEn": "Cotton", "value": "cotton" },
        { "labelZh": "化纤", "labelEn": "Polyester", "value": "polyester" }
      ]
    }
  ]
  */

  // 价格和图片视频 (后台配置)
  price                 Decimal? // 销售单价 (后台填写)
  images                Json?    // 图片集 (JSON数组: [{url, order, size, width, height}])
  video                 Json?    // 独立视频 (JSON: {url, size, duration, thumbnail})
  useSharedVideo        Boolean  @default(true) @map("use_shared_video") // 是否使用SKU组共用视频

  importDate            DateTime? @map("import_date") // 导入时间
  status                SkuStatus @default(INACTIVE) // active/inactive (默认未上架)
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  group             ProductGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  orderItems        OrderItem[]

  @@map("product_skus")
}

enum SkuStatus {
  ACTIVE   @map("active")
  INACTIVE @map("inactive")
}

// ========================================
// 首页精选系列展示位表 (2025-10-31 新增)
// ========================================
model HomepageFeatured {
  id              String   @id @default(uuid())
  groupId         String   @map("group_id") // 关联的SKU组ID
  featuredImage   String   @map("featured_image") // 展示图片URL
  titleZh         String   @map("title_zh") // 标题-中文
  titleEn         String   @map("title_en") // 标题-英文
  descriptionZh   String?  @map("description_zh") // 描述-中文
  descriptionEn   String?  @map("description_en") // 描述-英文
  sortOrder       Int      @map("sort_order") // 排序 (1-4)
  status          String   @default("active") // active/inactive
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  group           ProductGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@map("homepage_featured")
}

// ========================================
// 系统配置表
// ========================================
model SystemConfig {
  id          String   @id @default(uuid())
  configKey   String   @unique @map("config_key")
  configValue String?  @map("config_value")
  configType  String?  @map("config_type") // json, text, number
  description String?
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("system_configs")
}

// ========================================
// 订阅表
// ========================================
model Subscription {
  id            String   @id @default(uuid())
  email         String   @unique
  source        String?  // footer, popup, etc
  status        SubscriptionStatus @default(ACTIVE)
  subscribedAt  DateTime @default(now()) @map("subscribed_at")

  @@map("subscriptions")
}

enum SubscriptionStatus {
  ACTIVE       @map("active")
  UNSUBSCRIBED @map("unsubscribed")
}

// ========================================
// 合作申请表
// ========================================
model PartnershipApplication {
  id        String   @id @default(uuid())
  name      String
  company   String?
  email     String
  phone     String?
  message   String? 
  status    PartnershipStatus @default(PENDING)
  notes     String? 
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("partnership_applications")
}

enum PartnershipStatus {
  PENDING   @map("pending")
  CONTACTED @map("contacted")
  PARTNERED @map("partnered")
  REJECTED  @map("rejected")
}

// ========================================
// 资质认证表
// ========================================
model Certification {
  id                 String   @id @default(uuid())
  nameZh             String   @map("name_zh")
  nameEn             String   @map("name_en")
  category           CertCategory
  certificateType    String?  @map("certificate_type") // ISO9001, CE, FDA等
  fileUrl            String   @map("file_url")
  fileType           String?  @map("file_type") // pdf, jpg, png
  thumbnailUrl       String?  @map("thumbnail_url")
  issueDate          DateTime? @map("issue_date")
  expiryDate         DateTime? @map("expiry_date")
  issuingAuthority   String?  @map("issuing_authority")
  certificateNumber  String?  @map("certificate_number")
  descriptionZh      String?  @map("description_zh")
  descriptionEn      String?  @map("description_en")
  displayOrder       Int      @default(0) @map("display_order")
  isActive           Boolean  @default(true) @map("is_active")
  showOnFrontend     Boolean  @default(false) @map("show_on_frontend")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  @@map("certifications")
}

enum CertCategory {
  FACTORY @map("factory")
  PRODUCT @map("product")
  PATENT  @map("patent")
  HONOR   @map("honor")
  OTHER   @map("other")
}

// ========================================
// ========================================
// 组件管理表 (2025-11-10 新增)
// ========================================
model Component {
  id          String   @id @default(uuid())
  code        String   @unique // 组件代码，如: A, B, C
  nameZh      String   @map("name_zh") // 组件中文名称，如: 拖把杆
  nameEn      String   @map("name_en") // 组件英文名称，如: Mop Handle
  description String?  // 组件描述（可选）
  parts       Json?    // 部件列表，格式: [{ nameZh: "杆身", nameEn: "Pole Body" }, ...]
  sortOrder   Int      @default(0) @map("sort_order") // 排序权重
  isActive    Boolean  @default(true) @map("is_active") // 是否启用
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("components")
}

// ========================================
// 购物车表（内网版本 - 业务员使用）
// ========================================
model CartItem {
  id              String   @id @default(uuid())
  salespersonId   String   @map("salesperson_id") // 关联业务员
  skuId           String   @map("sku_id")
  productCode     String   @map("product_code") // 产品代码，如: C04.01.0021
  productName     String   @map("product_name") // 产品名称
  colorScheme     Json?    @map("color_scheme") // 配色方案 JSON
  quantity        Int      @default(1)
  price           Decimal // 单价
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // 订单明细扩展字段
  productCategory       String?   @map("product_category")       // 产品类别: new, old, sample
  customerProductCode   String?   @map("customer_product_code")  // 客户料号
  untaxedLocalCurrency  Decimal?  @map("untaxed_local_currency") // 未税本位币
  expectedDeliveryDate  DateTime? @map("expected_delivery_date") // 预交日
  packingQuantity       Int?      @map("packing_quantity")       // 装箱数
  cartonQuantity        Int?      @map("carton_quantity")        // 箱数
  packagingMethod       String?   @map("packaging_method")       // 包装方式
  paperCardCode         String?   @map("paper_card_code")        // 纸卡编码
  washLabelCode         String?   @map("wash_label_code")        // 水洗标编码
  outerCartonCode       String?   @map("outer_carton_code")      // 外箱编码
  cartonSpecification   String?   @map("carton_specification")   // 箱规
  volume                Decimal?  @map("volume")                 // 体积
  supplierNote          String?   @map("supplier_note")          // 厂商备注
  summary               String?   @map("summary")                // 摘要

  salesperson     Salesperson @relation(fields: [salespersonId], references: [id], onDelete: Cascade)

  @@unique([salespersonId, skuId, colorScheme])
  @@index([salespersonId])
  @@map("cart_items")
}

// ========================================
// ERP 客户映射表
// ========================================
model ErpCustomerMapping {
  id                    String   @id @default(uuid())
  websiteCustomerId     String   @unique @map("website_customer_id")
  erpCustomerNo         String   @map("erp_customer_no") // ERP CUST.CUS_NO
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  @@map("erp_customer_mapping")
}

// ========================================
// ERP 业务员映射表
// ========================================
model ErpSalespersonMapping {
  id                    String   @id @default(uuid())
  websiteSalespersonId  String   @unique @map("website_salesperson_id")
  erpSalespersonNo      String   @map("erp_salesperson_no") // ERP SAL_NO (如 MP0005)
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  @@map("erp_salesperson_mapping")
}
