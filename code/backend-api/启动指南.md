# 后台启动指南

## ⚠️ npm 问题说明

您的系统 npm 存在一些问题，无法正常安装依赖。请使用以下方案之一：

## 解决方案

### 方案1: 安装 pnpm（推荐）

```bash
# 全局安装 pnpm
npm install -g pnpm

# 进入后端目录
cd code/backend-api

# 安装依赖
pnpm install

# 生成 Prisma Client
npx prisma generate

# 启动开发服务器
pnpm run start:dev
```

### 方案2: 安装 yarn

```bash
# 全局安装 yarn
npm install -g yarn

# 进入后端目录
cd code/backend-api

# 安装依赖
yarn install

# 生成 Prisma Client
npx prisma generate

# 启动开发服务器
yarn start:dev
```

### 方案3: 修复 npm

```bash
# 清理 npm 缓存
npm cache clean --force

# 删除 node_modules
cd code/backend-api
rmdir /s /q node_modules

# 删除 package-lock.json
del package-lock.json

# 重新安装（使用 --force）
npm install --force

# 生成 Prisma Client
npx prisma generate

# 启动开发服务器
npm run start:dev
```

## 数据库配置

### 1. 创建 MySQL 数据库

```sql
CREATE DATABASE lemopx_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

### 2. 配置 .env 文件

编辑 `code/backend-api/.env` 文件，修改数据库连接：

```env
DATABASE_URL="mysql://root:你的密码@localhost:3306/lemopx_db"
JWT_SECRET="dev-jwt-secret-key-2024"
JWT_EXPIRATION="7d"
PORT=3001
NODE_ENV="development"
UPLOAD_DIR="./uploads"
MAX_FILE_SIZE=5242880
CORS_ORIGIN="http://localhost:3000"
```

### 3. 同步数据库

```bash
cd code/backend-api

# 生成 Prisma Client
npx prisma generate

# 同步数据库表结构
npx prisma db push

# （可选）打开 Prisma Studio 查看数据库
npx prisma studio
```

## 启动服务器

```bash
cd code/backend-api

# 开发模式（热重载）
npm run start:dev
# 或
pnpm run start:dev
# 或
yarn start:dev

# 服务器将运行在: http://localhost:3001/api
```

## 测试 API

### 1. 注册管理员

```bash
curl -X POST http://localhost:3001/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin",
    "email": "admin@lemopx.com",
    "password": "password123"
  }'
```

### 2. 登录

```bash
curl -X POST http://localhost:3001/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin",
    "password": "password123"
  }'
```

将返回的 `access_token` 用于后续请求。

### 3. 测试受保护的端点

```bash
curl -X GET http://localhost:3001/api/auth/profile \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN"
```

## 常见问题

### Q1: 端口被占用

修改 `.env` 中的 `PORT=3001` 为其他端口。

### Q2: 数据库连接失败

- 检查 MySQL 是否运行
- 检查 `.env` 中的数据库连接信息
- 确认数据库 `lemopx_db` 已创建

### Q3: Prisma 相关错误

```bash
# 重新生成 Prisma Client
npx prisma generate

# 重新同步数据库
npx prisma db push
```

### Q4: TypeScript 编译错误

```bash
# 清理构建
rm -rf dist

# 重新构建
npm run build
```

## 完整的启动流程（首次）

```bash
# 1. 安装包管理器（选一个）
npm install -g pnpm

# 2. 进入后端目录
cd code/backend-api

# 3. 安装依赖
pnpm install

# 4. 配置 .env 文件（修改数据库连接）
# 编辑 .env 文件

# 5. 创建数据库
# 在 MySQL 中执行: CREATE DATABASE lemopx_db;

# 6. 生成 Prisma Client
npx prisma generate

# 7. 同步数据库
npx prisma db push

# 8. 启动开发服务器
pnpm run start:dev

# 9. 打开浏览器访问
# http://localhost:3001/api
```

## 成功标志

如果看到以下输出，说明启动成功：

```
🚀 Server is running on: http://localhost:3001/api
📁 Static files served from: /uploads/
```

## 下一步

启动成功后，您可以：
1. 使用 Postman 或 curl 测试 API
2. 查看 API 文档：[docs/stage1-completion-report.md](../../docs/stage1-completion-report.md)
3. 开始对接前端
