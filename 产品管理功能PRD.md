# 产品管理功能 PRD v3.0 (最终版)

## 一、需求概述

### 1.1 业务背景
- 公司产品采用"产品组 → 规格 → 部件 → 颜色"的层级结构
- 产品数据来源：Excel导入 或 ERP数据库对接
- 导入后需要支持后台编辑：价格、描述、图片、视频等
- **前台用户采用Apple风格的渐进式选择体验**

### 1.2 核心概念

#### 数据层级
```
产品组（ProductGroup）
  └─ 规格（ProductSku）= 一个品号
       ├─ 基本信息：品号、品名、商标、价格
       ├─ 媒体资源：图片(最多5张)、视频(1个)
       ├─ 产品描述：富文本
       └─ 部件配置（来自Excel解析，只读）
            └─ 部件列表
                 ├─ 部件编号：[A], [B], [C]...
                 ├─ 部件名称：伸缩铁杆、拖把...
                 ├─ 规格描述：φ19/22*0.27mm*1200mm
                 └─ 颜色配置：喷塑:3C冷灰 + 塑件:10C冷灰
```

#### 示例（更新：支持多颜色方案）
```
产品组：MP007系列（组合套装）
  ├─ 规格1：MP007-四件套 (品号: C10.01.0013)
  │    ├─ 价格：¥199
  │    ├─ 图片：5张
  │    ├─ 视频：独立视频
  │    └─ 部件配置：
  │         ├─ [A] 伸缩铁杆 | φ19/22*0.27mm*1200mm
  │         │    颜色方案1: 喷塑:3C冷灰 + 塑件:10C冷灰
  │         │    颜色方案2: 喷塑:黑色 + 塑件:白色
  │         │    颜色方案3: 喷塑:蓝色 + 塑件:白色
  │         │
  │         ├─ [B] 拖把 | 39*9cm
  │         │    颜色方案1: 塑件:10C冷灰 + 雪尼尔:10C冷灰 + 口袋布:白色
  │         │    颜色方案2: 塑件:白色 + 雪尼尔:蓝色 + 口袋布:白色
  │         │
  │         ├─ [C] 窗刷 | 标准
  │         │    颜色方案1: 塑件:10C冷灰 + TPR刮条:黑色
  │         │    颜色方案2: 塑件:白色 + TPR刮条:黑色
  │         │
  │         └─ [D] 尘掸 | 弯曲型
  │              颜色方案1: 塑件:10C冷灰 + 雪尼尔:10C冷灰
  │              颜色方案2: 塑件:白色 + 雪尼尔:蓝色
  │
  └─ 规格2：MP007-六件套 (品号: C10.01.0014)
       └─ ... (同样包含多个颜色方案)
```

#### Excel导入格式（临时规则，待实际格式确认后调整）
```excel
品号: C10.01.0013
品名: MP007-清洁四件套
附加属性（颜色）:
[A] 喷塑:3C冷灰+塑件:10C冷灰 | 喷塑:黑色+塑件:白色 | 喷塑:蓝色+塑件:白色
[B] 塑件:10C冷灰+雪尼尔:10C冷灰+口袋布:白色 | 塑件:白色+雪尼尔:蓝色+口袋布:白色
[C] 塑件:10C冷灰+TPR刮条:黑色 | 塑件:白色+TPR刮条:黑色
[D] 塑件:10C冷灰+雪尼尔:10C冷灰 | 塑件:白色+雪尼尔:蓝色
```

**解析规则：**
- 同一部件的多个颜色方案用 `|` 分隔
- 同一方案内的多个颜色部位用 `+` 分隔
- 颜色格式：`材质部位:颜色代码`

---

## 二、功能模块设计

### 模块1：产品列表页面

#### 2.1.1 页面布局

```
┌────────────────────────────────────────────────────────────┐
│  产品管理                     [🔍 搜索框] [筛选▼]            │
├────────────────────────────────────────────────────────────┤
│  [📥 下载模板] [📤 导入Excel] [➕ 新建产品组]                │
│                                                            │
│  显示: 共 5个产品组，12个规格                                │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  📦 MP007系列 (组合套装) - 2个规格            [编辑组] [▼]  │
│  ┌──────────────────────────────────────────────────────┐ │
│  │ 品号          品名              价格    图片    操作   │ │
│  │ ─────────────────────────────────────────────────── │ │
│  │ C10.01.0013  MP007-四件套      ¥199   5/5   [✏️编辑] │ │
│  │              4个部件配置                     [📋详情] │ │
│  │                                             [🗑删除] │ │
│  │ ─────────────────────────────────────────────────── │ │
│  │ C10.01.0014  MP007-六件套      ¥259   3/5   [✏️编辑] │ │
│  │              6个部件配置                     [📋详情] │ │
│  │                                             [🗑删除] │ │
│  └──────────────────────────────────────────────────────┘ │
│                                                            │
│  📦 TB001系列 (拖把类) - 1个规格                   [编辑组] │
│  (已折叠，点击展开)                                         │
└────────────────────────────────────────────────────────────┘
```

#### 2.1.2 搜索功能
- **搜索字段**：品号、品名、商标
- **搜索方式**：实时搜索（debounce 300ms）
- **搜索逻辑**：模糊匹配，支持拼音首字母

#### 2.1.3 筛选功能
- 按分类筛选（组合套装、拖把类、刷类等）
- 按状态筛选（启用/停用）
- 按价格区间筛选
- 按是否有图片筛选
- 按是否有视频筛选

#### 2.1.4 批量操作
- 批量启用/停用
- 批量删除
- 批量导出

---

### 模块2：编辑规格（核心功能）

点击"编辑"按钮后，从右侧滑出编辑抽屉（宽度：800px）

#### 2.2.1 界面结构

```
┌─────────────────────────────────────────────────────────┐
│  ✕ 编辑规格 - MP007-四件套 (C10.01.0013)                 │
├─────────────────────────────────────────────────────────┤
│  [基本信息] [图片视频] [部件配置] [产品描述]  ← Tab切换   │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  【Tab 1: 基本信息】                                     │
│  ┌───────────────────────────────────────────────────┐ │
│  │ 品号: C10.01.0013  [不可编辑，灰色显示]            │ │
│  │ 品名: [MP007-清洁四件套___________]                │ │
│  │ 商标: [LEMOPX____________________]                │ │
│  │ 价格: ¥ [199.00___] (支持小数点两位)              │ │
│  │ 状态: (●) 启用  ( ) 停用                          │ │
│  └───────────────────────────────────────────────────┘ │
│                                                         │
│  【Tab 2: 图片视频】                                     │
│  ┌───────────────────────────────────────────────────┐ │
│  │ 📷 产品图片 (最多5张，可拖拽排序)                   │ │
│  │ ┌──┐ ┌──┐ ┌──┐ ┌──┐ ┌──┐                        │ │
│  │ │+ │ │📷│ │📷│ │📷│ │  │                        │ │
│  │ │上│ │🗑│ │🗑│ │🗑│ │  │                        │ │
│  │ │传│ │  │ │  │ │  │ │  │                        │ │
│  │ └──┘ └──┘ └──┘ └──┘ └──┘                        │ │
│  │ 3/5张                                              │ │
│  │                                                    │ │
│  │ 🎬 产品视频                                         │ │
│  │ ( ) 使用产品组共享视频 (当前: MP007系列宣传片)      │ │
│  │ (●) 使用独立视频                                   │ │
│  │     ┌────────────────────────────────────────┐   │ │
│  │     │ [📹 上传视频文件] 或 [🔗 输入视频URL]   │   │ │
│  │     └────────────────────────────────────────┘   │ │
│  │     [视频预览播放器]                               │ │
│  └───────────────────────────────────────────────────┘ │
│                                                         │
│  【Tab 3: 部件配置】(只读展示，带颜色可视化)              │
│  ┌───────────────────────────────────────────────────┐ │
│  │ 🔧 部件 [A] - 伸缩铁杆                             │ │
│  │   规格: φ19/22*0.27mm*1200mm                      │ │
│  │   说明: 意标螺纹                                   │ │
│  │   颜色配置:                                        │ │
│  │   ┌─────────────────────────────────────────────┐ │ │
│  │   │ 喷塑:   3C冷灰  [● #B8BFC6]  ← Pantone     │ │ │
│  │   │ 塑件:   10C冷灰 [● #D1D5D8]  ← Pantone     │ │ │
│  │   └─────────────────────────────────────────────┘ │ │
│  │                                                    │ │
│  │ 🔧 部件 [B] - 拖把                                 │ │
│  │   规格: 39*9cm                                     │ │
│  │   说明: 四孔面板+雪尼尔拖把布头                     │ │
│  │   颜色配置:                                        │ │
│  │   ┌─────────────────────────────────────────────┐ │ │
│  │   │ 塑件:    10C冷灰 [● #D1D5D8]                │ │ │
│  │   │ 雪尼尔:  10C冷灰 [● #D1D5D8]                │ │ │
│  │   │ 口袋布:  白色     [● #FFFFFF]                │ │ │
│  │   └─────────────────────────────────────────────┘ │ │
│  │                                                    │ │
│  │ 🔧 部件 [C] - 窗刷                                 │ │
│  │   ... (同上)                                       │ │
│  └───────────────────────────────────────────────────┘ │
│                                                         │
│  【Tab 4: 产品描述】                                     │
│  ┌───────────────────────────────────────────────────┐ │
│  │ 富文本编辑器 (Tiptap)                              │ │
│  │ [B] [I] [U] [图片] [链接] [列表] [标题]            │ │
│  │ ┌─────────────────────────────────────────────┐   │ │
│  │ │                                              │   │ │
│  │ │ 这是一款高品质的MP007四件套清洁工具，包含：    │   │ │
│  │ │ • 伸缩铁杆：可调节长度1.2m-2.0m               │   │ │
│  │ │ • 拖把：高吸水雪尼尔材质                      │   │ │
│  │ │ • ...                                        │   │ │
│  │ │                                              │   │ │
│  │ └─────────────────────────────────────────────┘   │ │
│  │ 字数: 256/5000                                     │ │
│  └───────────────────────────────────────────────────┘ │
│                                                         │
├─────────────────────────────────────────────────────────┤
│                      [取消]  [保存]                      │
└─────────────────────────────────────────────────────────┘
```

#### 2.2.2 图片上传详细规则

**上传规则：**
- 支持格式：JPG、PNG、WEBP
- 单张大小：最大5MB
- 最多数量：5张
- 自动压缩：前端压缩到最大1920x1920
- 支持拖拽：可拖拽排序

**上传流程：**
```
1. 用户选择图片
2. 前端验证（格式、大小）
3. 前端压缩（Canvas）
4. 上传到后端 /api/upload/single
5. 后端保存到 uploads/ 目录
6. 返回图片URL
7. 前端保存URL到表单
8. 点击"保存"时提交完整数据
```

#### 2.2.3 视频处理

**方式1：上传视频文件**
- 支持格式：MP4、MOV、AVI
- 大小限制：最大100MB
- 上传到：uploads/videos/

**方式2：输入视频URL**
- 支持：YouTube、优酷、腾讯视频等
- 自动解析：获取embed链接
- 保存：URL字符串

**共享视频：**
- 使用产品组级别的视频
- 当选择"共享视频"时，显示产品组的视频
- 前端保存 `useSharedVideo: true`

---

### 模块3：Pantone颜色转换

#### 2.3.1 颜色库设计

基于Pantone色卡，建立颜色映射表：

```typescript
// pantoneColors.ts
{
  "3C冷灰": {
    code: "3C冷灰",
    hex: "#B8BFC6",
    rgb: [184, 191, 198],
    pantone: "Cool Gray 3C"
  },
  "10C冷灰": {
    code: "10C冷灰",
    hex: "#D1D5D8",
    rgb: [209, 213, 216],
    pantone: "Cool Gray 10C"
  },
  "白色": {
    code: "白色",
    hex: "#FFFFFF",
    rgb: [255, 255, 255],
    pantone: "White"
  },
  // ... 更多颜色
}
```

#### 2.3.2 颜色解析逻辑

```
输入（Excel/ERP）：
"喷塑:3C冷灰 + 塑件:10C冷灰"

步骤1：分割字符串
["喷塑:3C冷灰", "塑件:10C冷灰"]

步骤2：解析每个部分
[
  { part: "喷塑", colorCode: "3C冷灰" },
  { part: "塑件", colorCode: "10C冷灰" }
]

步骤3：查询Pantone色卡
[
  { part: "喷塑", colorCode: "3C冷灰", hex: "#B8BFC6" },
  { part: "塑件", colorCode: "10C冷灰", hex: "#D1D5D8" }
]

步骤4：前端渲染
[文字：喷塑] [圆形色块：●#B8BFC6] [文字：3C冷灰]
  +
[文字：塑件] [圆形色块：●#D1D5D8] [文字：10C冷灰]
```

---

## 三、数据结构

### 3.1 数据库Schema

```prisma
model ProductGroup {
  id                    String    @id @default(uuid())
  prefix                String    @unique          // MP007
  groupNameZh           String                      // MP007系列
  groupNameEn           String?                     // MP007 Series
  categoryId            String
  categoryCode          String

  descriptionZh         String?
  descriptionEn         String?

  // 产品组共享媒体
  sharedVideo           Json?     // {type: 'file'|'link', url: string}
  mainImage             String?   // 产品组主图

  isPublished           Boolean   @default(true)
  sortOrder             Int       @default(0)
  status                String    @default("inactive")

  category              ProductCategory @relation(...)
  skus                  ProductSku[]

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@map("product_groups")
}

model ProductSku {
  id                    String    @id @default(uuid())
  groupId               String

  // 基本信息（可编辑）
  productCode           String    @unique         // 品号
  productName           String                    // 品名
  brand                 String?                   // 商标
  price                 Decimal?                  // 价格
  description           String?   @db.Text       // 富文本描述

  // Excel解析数据（只读）
  specification         String?                   // 原始规格文本
  productSpec           Json?                     // 解析后的部件规格
  /*
  productSpec 格式:
  [
    {
      code: "A",
      name: "伸缩铁杆",
      spec: "φ19/22*0.27mm*1200mm",
      description: "意标螺纹"
    }
  ]
  */

  additionalAttributes  Json?                     // 解析后的颜色属性
  /*
  additionalAttributes 格式:
  [
    {
      componentCode: "A",
      colors: [
        { part: "喷塑", color: "3C冷灰" },
        { part: "塑件", color: "10C冷灰" }
      ]
    }
  ]
  */

  // 媒体资源（可编辑）
  images                Json?                     // 产品图片
  /*
  images 格式:
  [
    { url: "https://cdn.../1.jpg", order: 1 },
    { url: "https://cdn.../2.jpg", order: 2 }
  ]
  */

  video                 Json?                     // 独立视频
  /*
  video 格式:
  {
    type: "file" | "link",
    url: "https://..."
  }
  */

  useSharedVideo        Boolean   @default(true)  // 是否使用产品组共享视频

  // 状态
  status                String    @default("INACTIVE")  // ACTIVE | INACTIVE
  importDate            DateTime?

  group                 ProductGroup @relation(...)

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@map("product_skus")
}
```

### 3.2 API数据格式

#### 获取规格详情 GET /api/products/skus/:id

**返回：**
```json
{
  "id": "uuid",
  "productCode": "C10.01.0013",
  "productName": "MP007-清洁四件套",
  "brand": "LEMOPX",
  "price": "199.00",
  "description": "<p>这是产品描述...</p>",
  "status": "ACTIVE",

  "productSpec": [
    {
      "code": "A",
      "name": "伸缩铁杆",
      "spec": "φ19/22*0.27mm*1200mm",
      "description": "意标螺纹"
    }
  ],

  "additionalAttributes": [
    {
      "componentCode": "A",
      "colors": [
        { "part": "喷塑", "color": "3C冷灰" },
        { "part": "塑件", "color": "10C冷灰" }
      ]
    }
  ],

  "images": [
    { "url": "https://cdn.../1.jpg", "order": 1 },
    { "url": "https://cdn.../2.jpg", "order": 2 }
  ],

  "video": {
    "type": "file",
    "url": "https://cdn.../video.mp4"
  },

  "useSharedVideo": false,

  "group": {
    "id": "uuid",
    "prefix": "MP007",
    "groupNameZh": "MP007系列",
    "sharedVideo": {
      "type": "link",
      "url": "https://youtube.com/..."
    }
  }
}
```

#### 更新规格 PATCH /api/products/skus/:id

**请求体：**
```json
{
  "productName": "MP007-清洁四件套",
  "brand": "LEMOPX",
  "price": 199.00,
  "description": "<p>这是产品描述...</p>",
  "status": "ACTIVE",

  "images": [
    { "url": "https://cdn.../1.jpg", "order": 1 },
    { "url": "https://cdn.../2.jpg", "order": 2 },
    { "url": "https://cdn.../3.jpg", "order": 3 }
  ],

  "useSharedVideo": false,
  "video": {
    "type": "file",
    "url": "https://cdn.../video.mp4"
  }
}
```

---

## 四、前后端分工

### 前端需要实现

1. ✅ **产品列表页面重构**
   - 按产品组分组展示
   - 搜索功能（实时搜索）
   - 筛选功能（分类、状态、价格等）
   - 批量操作（启用/停用/删除）

2. ✅ **编辑规格抽屉**
   - Tab切换（基本信息、图片视频、部件配置、产品描述）
   - 表单验证
   - 图片上传组件（拖拽排序、删除）
   - 视频上传/URL输入
   - 富文本编辑器

3. ✅ **Pantone颜色组件**
   - 颜色映射表（pantoneColors.ts）
   - 颜色显示组件（ColorDisplay.tsx）
   - 颜色解析函数

4. ✅ **图片上传组件**
   - 拖拽上传
   - 图片压缩
   - 排序功能
   - 预览和删除

### 后端需要实现

1. ✅ **SKU查询API增强**
   - GET /api/products/skus/:id （获取单个规格详情）
   - 返回包含group信息（包括sharedVideo）

2. ✅ **SKU更新API**
   - PATCH /api/products/skus/:id
   - 支持更新：productName, brand, price, description, images, video, useSharedVideo, status

3. ✅ **图片上传API**
   - POST /api/upload/single （已存在）
   - 确保返回完整的URL

4. ✅ **视频上传API**
   - POST /api/upload/video （新增）
   - 处理大文件上传
   - 返回视频URL

5. ✅ **搜索和筛选API**
   - GET /api/products/skus?search=xxx&category=xxx&status=xxx
   - 支持多条件查询

---

## 五、开发优先级

### P0 - 核心功能（必须有）
1. ✅ 编辑规格 - 基本信息（品名、价格、状态）
2. ✅ 编辑规格 - 图片上传（最多5张）
3. ✅ 产品列表 - 按产品组展示
4. ✅ 搜索功能

### P1 - 重要功能（尽快有）
1. ✅ 编辑规格 - 视频上传/链接
2. ✅ 编辑规格 - 富文本描述
3. ✅ Pantone颜色显示
4. ✅ 筛选功能

### P2 - 优化功能（可以后续加）
1. 批量操作
2. 图片拖拽排序优化
3. 导入结果详细展示优化
4. 导出功能

---

## 六、测试要点

### 6.1 功能测试
- [ ] 搜索功能：能正确搜索品号、品名
- [ ] 编辑价格：能正确保存小数点两位
- [ ] 上传图片：最多5张，超过限制时提示
- [ ] 删除图片：点击删除后立即从列表移除
- [ ] 图片排序：拖拽后顺序改变
- [ ] 视频上传：能上传MP4文件
- [ ] 视频URL：能输入YouTube链接
- [ ] 共享视频：切换后显示产品组视频
- [ ] 颜色显示：正确显示Pantone色块
- [ ] 富文本编辑：能插入图片、链接

### 6.2 边界测试
- [ ] 上传超大图片：应压缩或拒绝
- [ ] 上传错误格式：应提示错误
- [ ] 价格输入非数字：应验证失败
- [ ] 必填字段为空：应提示错误
- [ ] 网络中断时上传：应显示错误

### 6.3 性能测试
- [ ] 1000个SKU时列表加载速度
- [ ] 图片压缩不应卡顿
- [ ] 搜索实时响应（< 300ms）

---

## 七、开放问题

### 7.1 待确认
- [ ] Pantone色卡是否需要支持自定义颜色？
- [ ] 视频文件大小限制是100MB还是其他？
- [ ] 富文本编辑器是否需要支持表格？

### 7.2 后续优化
- [ ] 是否需要版本管理（修改历史）？
- [ ] 是否需要审批流程？
- [ ] 是否需要多语言支持？
